<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">

  <title>Fox App</title>
  <style>
    :root {
      color-scheme: light dark;
      --vh: 1vh;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #000;
      overflow: hidden;
      height: calc(var(--vh) * 100);
    }

    /* ===== VIEWPORT SCALE (SAFE AREA) ===== */
    .viewport {
      position: fixed;
      inset: 0;
      height: calc(var(--vh) * 100);
      display: flex;
      justify-content: center;
      align-items: center;

      padding:
        calc(12px + env(safe-area-inset-top)) calc(12px + env(safe-area-inset-right)) calc(12px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));
      box-sizing: border-box;
    }

    /* ===== APP GỐC (TỈ LỆ 9:16) ===== */
    .app {
      width: 1080px;
      height: 1920px;
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: #111;

      flex: none;
      /* IMPORTANT: stop flexbox resizing */
      transform-origin: center;
      /* scaling anchor */
      will-change: transform;
    }

    /* ===== BACKGROUND: 2 LỚP CHỒNG NHAU (KHÔNG NHÁY) ===== */
    .bg-layer {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      opacity: 0;
      transition: opacity 240ms ease;
      will-change: opacity;
    }

    .bg-layer.active {
      opacity: 1;
    }

    /* ===== VIDEO: 2 LỚP CHỒNG NHAU (KHÔNG NHÁY) ===== */
    .fox-video {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      border-radius: 16px;
      background: transparent;

      opacity: 0;
      transition: opacity 240ms ease;
      will-change: opacity;
    }

    .fox-video.active {
      opacity: 1;
    }

    /* ===== HUD SCORE ===== */
    .score {
      position: absolute;
      top: 24px;
      left: 24px;

      padding: 18px 22px;
      border-radius: 18px;

      background: rgba(0, 0, 0, .45);
      border: 1px solid rgba(255, 255, 255, .12);
      backdrop-filter: blur(6px);

      font-weight: 600;
      font-size: 36px;
      letter-spacing: 1px;

      user-select: none;
      z-index: 10;
    }

    /* ===== BUTTON PNG ===== */
    .png-btn {
      position: absolute;
      top: 10px;
      right: 24px;
      width: 150px;
      height: 150px;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      display: grid;
      place-items: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .45));
      z-index: 10;
    }

    .png-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .png-btn.pressed {
      animation: pressPop 180ms ease-out;
    }

    @keyframes pressPop {
      0% {
        transform: scale(1);
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .45));
      }

      60% {
        transform: scale(0.92);
        filter: drop-shadow(0 0 18px rgba(255, 255, 255, .35));
      }

      100% {
        transform: scale(1);
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .45));
      }
    }

    .float-plus {
      position: absolute;
      right: 60px;
      bottom: 240px;
      font-weight: 800;
      font-size: 26px;
      color: #fff;
      text-shadow: 0 6px 18px rgba(0, 0, 0, .55);
      pointer-events: none;
      user-select: none;
      animation: floatUp 650ms ease-out forwards;
      z-index: 10;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(0.95);
        opacity: 0;
      }

      15% {
        opacity: 1;
      }

      100% {
        transform: translateY(-70px) scale(1.08);
        opacity: 0;
      }
    }

    /* ===== CONTROLS ===== */
    .controls {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, .45);
      border: 1px solid rgba(255, 255, 255, .12);
      backdrop-filter: blur(6px);
      z-index: 10;
    }

    .spacer {
      flex: 1;
    }

    label {
      font-size: 12px;
      opacity: .9;
    }

    input[type="range"] {
      width: 160px;
    }
  </style>
</head>

<body>
  <div class="viewport">
    <div class="app" id="app">

      <!-- 2 BACKGROUND LAYER -->
      <div id="bgA" class="bg-layer active" style='background-image:url("./assets/Room_Level_1.png")'></div>
      <div id="bgB" class="bg-layer" style='background-image:url("./assets/Room_Level_1.png")'></div>

      <div class="score">Điểm cáo: <span id="scoreVal">0</span></div>
      <button class="png-btn" id="pointBtn" aria-label="Cộng điểm">
        <img src="./assets/Buton.png" alt="Cộng điểm" />
      </button>

      <!-- 2 VIDEO LAYER -->
      <video id="foxVideoA" class="fox-video active" src="./assets/FoxTrue.webm" autoplay muted playsinline
        preload="auto"></video>
      <video id="foxVideoB" class="fox-video" src="" autoplay muted playsinline preload="auto"></video>

      <div class="controls">
        <button id="playBtn">Play</button>
        <button id="pauseBtn">Pause</button>
        <button id="toggleMuteBtn">Mute/Unmute</button>
        <div class="spacer"></div>

        <div>
          <label>Size</label><br>
          <input id="size" type="range" min="10" max="150" value="70">
        </div>
        <div>
          <label>X</label><br>
          <input id="posX" type="range" min="-50" max="50" value="0">
        </div>
        <div>
          <label>Y</label><br>
          <input id="posY" type="range" min="-50" max="50" value="0">
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== SCALE THE WHOLE APP (TỈ LỆ 9:16) =====
    const DESIGN_W = 1080;
    const DESIGN_H = 1920;

    function getViewportSize() {
      if (window.visualViewport) {
        return { w: window.visualViewport.width, h: window.visualViewport.height };
      }
      return { w: window.innerWidth, h: window.innerHeight };
    }

    function layout() {
      // real phone height (fix 100vh)
      const realVH = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${realVH}px`);

      // scale canvas
      const appEl = document.getElementById('app');
      const { w: vw, h: vh } = getViewportSize();

      // must match your .viewport padding: 12px left + 12px right = 24 (same for top/bottom)
      const usableW = Math.max(1, vw - 24);
      const usableH = Math.max(1, vh - 24);

      const scale = Math.min(usableW / DESIGN_W, usableH / DESIGN_H);
      appEl.style.transform = `scale(${Math.min(scale, 1)})`;
    }

    window.addEventListener('resize', layout);
    window.addEventListener('orientationchange', layout);

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', layout);
      window.visualViewport.addEventListener('scroll', layout);
    }

    layout();





    function updateRealVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    window.addEventListener('resize', updateRealVH);
    window.addEventListener('orientationchange', updateRealVH);

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateRealVH);
      window.visualViewport.addEventListener('scroll', updateRealVH);
    }

    updateRealVH();

    // ===== MAIN =====
    const app = document.getElementById('app');

    // bg layers
    const bgA = document.getElementById('bgA');
    const bgB = document.getElementById('bgB');
    let activeBg = bgA;
    let idleBg = bgB;

    // video layers
    const vA = document.getElementById('foxVideoA');
    const vB = document.getElementById('foxVideoB');
    let activeVideo = vA;
    let idleVideo = vB;

    const size = document.getElementById('size');
    const posX = document.getElementById('posX');
    const posY = document.getElementById('posY');

    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const toggleMuteBtn = document.getElementById('toggleMuteBtn');

    const scoreVal = document.getElementById('scoreVal');
    const pointBtn = document.getElementById('pointBtn');

    let score = 0;
    let muted = true;

    function spawnPlus10() {
      const el = document.createElement('div');
      el.className = 'float-plus';
      el.textContent = '+10';
      app.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    }
    function pressEffect() {
      pointBtn.classList.remove('pressed');
      void pointBtn.offsetWidth;
      pointBtn.classList.add('pressed');
    }

    // ===== LEVEL UP CONFIG (GIỮ NGUYÊN LINK CỦA BẠN) =====
    const LEVEL_SCORE = 50;

    const DEFAULT_BG = './assets/Room_Level_1.png';
    const NEW_BG = './assets/Room_Level_3.png';

    const DEFAULT_VIDEO = './assets/FoxTrue.webm';
    const NEW_VIDEO = './assets/FoxFuture.webm';

    // preload ảnh để đổi nền mượt
    (() => {
      const i1 = new Image(); i1.src = DEFAULT_BG;
      const i2 = new Image(); i2.src = NEW_BG;
    })();

    function applyMute() {
      activeVideo.muted = muted;
      idleVideo.muted = muted;
    }
    function safePlay(v) {
      const p = v.play();
      if (p && typeof p.catch === "function") p.catch(() => { });
    }

    function swapBgRefs() {
      const t = activeBg; activeBg = idleBg; idleBg = t;
    }
    function swapVideoRefs() {
      const t = activeVideo; activeVideo = idleVideo; idleVideo = t;
    }

    async function swapBackgroundNoFlicker(newBgUrl) {
      // set bg vào lớp idle trước
      idleBg.style.backgroundImage = `url("${newBgUrl}")`;
      // force reflow để chắc chắn browser áp style
      void idleBg.offsetWidth;

      // crossfade
      idleBg.classList.add('active');
      activeBg.classList.remove('active');

      // đợi fade xong
      await new Promise(r => setTimeout(r, 260));

      swapBgRefs();
    }

    let currentVideoUrl = DEFAULT_VIDEO;

    async function swapVideoNoFlicker(newVideoUrl) {
      if (currentVideoUrl === newVideoUrl) return;

      const keepTime = activeVideo.currentTime || 0;

      idleVideo.src = newVideoUrl;
      idleVideo.load();
      applyMute();

      // chờ decode frame
      await new Promise(resolve => {
        const done = () => {
          idleVideo.removeEventListener('canplay', done);
          resolve();
        };
        idleVideo.addEventListener('canplay', done, { once: true });
      });

      try { idleVideo.currentTime = keepTime; } catch { }
      safePlay(idleVideo);

      // crossfade
      idleVideo.classList.add('active');
      activeVideo.classList.remove('active');

      await new Promise(r => setTimeout(r, 260));

      try { activeVideo.pause(); } catch { }
      swapVideoRefs();
      currentVideoUrl = newVideoUrl;

      applyTransform();
    }

    let leveledUp = false;
    async function levelUpIfNeeded() {
      if (leveledUp) return;
      if (score < LEVEL_SCORE) return;
      leveledUp = true;

      await Promise.all([
        swapBackgroundNoFlicker(NEW_BG),
        swapVideoNoFlicker(NEW_VIDEO),
      ]);
    }

    // ===== TIMELINE (20s, mỗi đoạn 5s) =====
    const A0 = 0.0, A1 = 5.0;
    const B0 = 5.0, B1 = 10.0;
    const C0 = 10.0, C1 = 15.0;
    const D0 = 15.0, D1 = 20.0;

    const EPS = 0.035;

    let state = "A_RUN";
    let aCount = 0;
    let feedQueued = false;

    function gotoTime(t) {
      try { activeVideo.currentTime = Math.max(0, t + 0.001); } catch { }
    }

    function startAFromBeginning() {
      state = "A_RUN";
      aCount = 0;
      feedQueued = false;
      gotoTime(A0);
    }

    function tick() {
      const t = activeVideo.currentTime || 0;

      if (state === "A_RUN") {
        if (t < A0 - EPS || t > A1 + EPS) gotoTime(A0);

        if (t >= A1 - EPS) {
          aCount += 1;
          if (aCount < 2) {
            gotoTime(A0);
          } else {
            state = "BC_RUN";
            gotoTime(B0);
          }
        }
      }
      else if (state === "BC_RUN") {
        if (t >= C1 - EPS) {
          state = "C_LOOP";
          gotoTime(C0);
        }
      }
      else if (state === "C_LOOP") {
        if (t < C0 - EPS || t > C1 + EPS) gotoTime(C0);

        if (t >= C1 - EPS) {
          if (feedQueued) {
            feedQueued = false;
            state = "D_RUN";
            gotoTime(D0);
          } else {
            gotoTime(C0);
          }
        }
      }
      else if (state === "D_RUN") {
        if (t >= D1 - EPS) startAFromBeginning();
      }

      requestAnimationFrame(tick);
    }

    pointBtn.addEventListener("click", () => {
      score += 10;
      scoreVal.textContent = String(score);

      pressEffect();
      spawnPlus10();

      levelUpIfNeeded();

      if (state === "C_LOOP") feedQueued = true;
    });

    function applyTransform() {
      const s = Number(size.value);
      const x = Number(posX.value);
      const y = Number(posY.value);

      [vA, vB].forEach(v => {
        v.style.width = `${s}%`;
        v.style.left = `calc(50% + ${x}%)`;
        v.style.top = `calc(50% + ${y}%)`;
      });
    }

    size.addEventListener('input', applyTransform);
    posX.addEventListener('input', applyTransform);
    posY.addEventListener('input', applyTransform);

    playBtn.addEventListener('click', async () => { try { await activeVideo.play(); } catch { } });
    pauseBtn.addEventListener('click', () => activeVideo.pause());
    toggleMuteBtn.addEventListener('click', () => {
      muted = !muted;
      applyMute();
    });

    // init
    applyTransform();
    applyMute();

    // đảm bảo bg idle cũng đúng DEFAULT_BG lúc đầu
    idleBg.style.backgroundImage = `url("${DEFAULT_BG}")`;

    // start loop logic khi video load xong
    vA.addEventListener("loadedmetadata", () => {
      startAFromBeginning();
      safePlay(activeVideo);
      requestAnimationFrame(tick);
    }, { once: true });
  </script>
</body>

</html>